{% extends "base.html" %}

{% block content %}
<h1>Habilitar ou desabilitar downstream-fec</h1>

<hr>

<form method="POST" action="{{url_for('downstream_fec_bp.downstream_fec')}}" onsubmit="return mySubmitFunction()"
    autocomplete="on">
    {{ form.hidden_tag() }}

    <div class="row mb-3">
        <div class="col">
            <div class="form-floating">
                {{ form.hostname(class="form-control searchable-select") }}
                {{ form.hostname.label }}
            </div>
        </div>
    </div>

    <div class="row g-3 mb-3">
        <div class="col-2">
            <div class="form-floating">
                {{ form.chassis(class="form-control") }}
                {{ form.chassis.label }}
            </div>
        </div>
        <div class="col-2">
            <div class="form-floating">
                {{ form.slot(class="form-control") }}
                {{ form.slot.label }}
            </div>
        </div>
        <div class="col-2">
            <div class="form-floating">
                {{ form.port_id(class="form-control") }}
                {{ form.port_id.label }}
            </div>
        </div>
        <div class="col">
            <div class="form-floating">
                {{ form.dmos_command(class="form-control") }}
                {{ form.dmos_command.label }}
            </div>
        </div>
    </div>

    {{ form.submit(class="btn btn-primary") }}
</form>

<br>

<smal class="text-muted"> show interface gpon {chassis}/{slot}/{port_id} </smal>
<pre class="border border-3 rounded-3 p-3">{{ output }}</pre>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectElement = document.querySelector('.searchable-select');
    
    if (selectElement) {
        // Criar container para o select customizado
        const container = document.createElement('div');
        container.className = 'searchable-select-container';
        container.style.position = 'relative';
        
        // Criar input de busca
        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.className = 'form-control searchable-input';
        searchInput.placeholder = '      Escreva aqui para filtrar OLTs...';
        searchInput.style.marginBottom = '5px';
        
        // Criar lista de opções
        const optionsList = document.createElement('div');
        optionsList.className = 'searchable-options';
        optionsList.style.cssText = `
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            background: white;
            position: absolute;
            width: 100%;
            z-index: 1000;
            display: none;
        `;
        
        // Armazenar todas as opções
        const allOptions = Array.from(selectElement.options).slice(1); // Remove a primeira opção vazia
        
        // Função para criar item da lista
        function createOptionItem(option) {
            const item = document.createElement('div');
            item.className = 'searchable-option';
            item.style.cssText = `
                padding: 8px 12px;
                cursor: pointer;
                border-bottom: 1px solid #f0f0f0;
            `;
            item.textContent = option.text;
            item.dataset.value = option.value;
            
            item.addEventListener('mouseenter', function() {
                this.style.backgroundColor = '#f8f9fa';
            });
            
            item.addEventListener('mouseleave', function() {
                this.style.backgroundColor = 'white';
            });
            
            item.addEventListener('click', function() {
                selectElement.value = this.dataset.value;
                searchInput.value = this.textContent;
                optionsList.style.display = 'none';
                
                // Disparar evento change no select original
                const event = new Event('change', { bubbles: true });
                selectElement.dispatchEvent(event);
            });
            
            return item;
        }
        
        // Função para filtrar opções
        function filterOptions(searchTerm) {
            optionsList.innerHTML = '';
            
            const filteredOptions = allOptions.filter(option => 
                option.text.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            if (filteredOptions.length === 0) {
                const noResults = document.createElement('div');
                noResults.style.cssText = 'padding: 8px 12px; color: #6c757d; font-style: italic;';
                noResults.textContent = 'Nenhuma OLT encontrada';
                optionsList.appendChild(noResults);
            } else {
                filteredOptions.forEach(option => {
                    optionsList.appendChild(createOptionItem(option));
                });
            }
        }
        
        // Event listeners
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value;
            filterOptions(searchTerm);
            optionsList.style.display = searchTerm ? 'block' : 'none';
        });
        
        searchInput.addEventListener('focus', function() {
            if (this.value) {
                filterOptions(this.value);
                optionsList.style.display = 'block';
            }
        });
        
        // Fechar lista ao clicar fora
        document.addEventListener('click', function(e) {
            if (!container.contains(e.target)) {
                optionsList.style.display = 'none';
            }
        });
        
        // Configurar valor inicial se já selecionado
        if (selectElement.value) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            searchInput.value = selectedOption.text;
        }
        
        // Inserir elementos no DOM
        selectElement.parentNode.insertBefore(container, selectElement);
        container.appendChild(searchInput);
        container.appendChild(optionsList);
        
        // Esconder select original
        selectElement.style.display = 'none';
        
        // Inicializar com todas as opções
        allOptions.forEach(option => {
            optionsList.appendChild(createOptionItem(option));
        });
    }
});
</script>
{% endblock %}